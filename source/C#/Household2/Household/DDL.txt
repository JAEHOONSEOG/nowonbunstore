--author : SoonYub Hwang
--Create Date: 2016/12/19

--Initialize
DROP TABLE HSHLD_LOG;
DROP TABLE HSHLD;
DROP TABLE CNCT_LG;
DROP TABLE USR_NF;
DROP TABLE GRP_NF;
DROP TABLE SYS_DT;
DROP TABLE TP;
DROP TABLE CTGRY; 

--Master
--Category(Master)
DROP TABLE CTGRY;
CREATE TABLE CTGRY(
	CD CHAR(3) COMMENT '카테코리코드',
	NM VARCHAR(20) COMMENT '카테고리이름',
	PRIMARY KEY(CD)
);
ALTER TABLE CTGRY COMMENT = '카테고리';

--Type(Master)
DROP TABLE TP;
CREATE TABLE TP(
	TP CHAR(3) COMMENT '타입',
	NM VARCHAR(20) COMMENT '타입이름',
	CD CHAR(3) COMMENT '카테고리코드',
	PRIMARY KEY(TP),
	FOREIGN KEY(CD) REFERENCES CTGRY(CD)
);
ALTER TABLE TP COMMENT = '타입';

--System data(Master)
DROP TABLE SYS_DT; 
CREATE TABLE SYS_DT(
	KYCD CHAR(5) COMMENT '시스템코드',
	DT VARCHAR(255) COMMENT '데이터',
	PRIMARY KEY(KYCD)
);
ALTER TABLE SYS_DT COMMENT = '시스템코드';


--Transaction
--Group Info(Transaction)
DROP TABLE GRP_NF;
CREATE TABLE GRP_NF(
	GRPD VARCHAR(10) COMMENT '그룹ID',
	GRPNM VARCHAR(255) COMMENT '그룹명',
	CPTN VARCHAR(255) COMMENT '캡션',
	PRIMARY KEY(GRPD)
);
ALTER TABLE GRP_NF COMMENT = '그룹정보';

--User Info(Transaction)
DROP TABLE USR_NF;
CREATE TABLE USR_NF(
	GRPD VARCHAR(10) COMMENT '그룹ID',
	USRD VARCHAR(10) COMMENT '유저ID',
	NM VARCHAR(255) COMMENT '유저명',
	PSWRD VARCHAR(255) COMMENT '패스워드',
	PRIMARY KEY(GRPD,USRD),
	FOREIGN KEY(GRPD) REFERENCES GRP_NF(GRPD)
);
ALTER TABLE USR_NF COMMENT = '유저정보';

--Connect Log(Transaction)
DROP TABLE CNCT_LG;
CREATE TABLE CNCT_LG(
    NDX INTEGER COMMENT '인덱스' AUTO_INCREMENT,
	GRPD VARCHAR(10) COMMENT '그룹ID',
	USRD VARCHAR(10) COMMENT '유저ID',
	CNCTM DATETIME COMMENT '접속시간',
	PRIMARY KEY(NDX),
	FOREIGN KEY(GRPD,USRD) REFERENCES USR_NF(GRPD,USRD)
);
ALTER TABLE CNCT_LG COMMENT = '접속로그';

--Household(Transaction)
DROP TABLE HSHLD;
CREATE TABLE HSHLD(
	NDX INT COMMENT '인덱스' AUTO_INCREMENT,
	GRPD VARCHAR(10) COMMENT '그룹ID',
	USRD VARCHAR(10) COMMENT '유저ID',
	CD CHAR(3) COMMENT '카테고리코드',
	TP CHAR(3) COMMENT '타입',
	DT DATE COMMENT '가계일시',
	CNTXT VARCHAR(255) COMMENT '가계내용',
	PRC NUMERIC(20) COMMENT '가계금액',
	PDT DATETIME COMMENT '등록일자',
	PRIMARY KEY(NDX),
	FOREIGN KEY(GRPD,USRD) REFERENCES USR_NF(GRPD,USRD),
	FOREIGN KEY(TP) REFERENCES TP(TP),
	FOREIGN KEY(CD) REFERENCES CTGRY(CD)
);
ALTER TABLE HSHLD COMMENT = '가계부';

--Household Log(Transaction)
DROP TABLE HSHLD_LOG;
CREATE TABLE HSHLD_LOG(
	NDX INT COMMENT '인덱스' AUTO_INCREMENT,
	NDX2 INT COMMENT '인덱스2',
	GRPD VARCHAR(10) COMMENT '그룹명',
	USRD VARCHAR(10) COMMENT '유저명',
	CD CHAR(3) COMMENT '카테고리코드',
	TP CHAR(3) COMMENT '타입',
	DT DATE COMMENT '가계일시',
	CNTXT VARCHAR(255) COMMENT '가계내용',
	PRC NUMERIC(20) COMMENT '가계금액',
	PDT DATETIME COMMENT '등록일자',
	CDT DATETIME COMMENT '편집일자',
	PRIMARY KEY(NDX)
);
ALTER TABLE HSHLD_LOG COMMENT = '가계부로그';
commit;

CREATE FUNCTION SUM_HOUSEHOLDPRICE(grpd varchar(10),tp char(3),startdate date,enddate date) 
RETURNS NUMERIC(20) DETERMINISTIC
BEGIN
	DECLARE rslt NUMERIC(20);
    SELECT SUM(PRC) INTO rslt FROM HSHLD 
    WHERE HSHLD.TP = tp
        AND HSHLD.GRPD = grpd
        AND HSHLD.DT >= startdate 
        AND HSHLD.DT < enddate;
    RETURN rslt;
END